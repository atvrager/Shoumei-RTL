#!/bin/bash
# Run all tests: code quality checks + smoke test

set -e

GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "  證明 Shoumei RTL - Full Test Suite"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# Test 1: Shellcheck
echo "==> Test 1: Shell Script Quality (shellcheck)"
if command -v shellcheck > /dev/null 2>&1; then
    # Check main scripts and verification scripts (exclude old auto-generated ones)
    SHELL_SCRIPTS=$(find . -name "*.sh" -type f \
        -not -path "./verification/FullAdder/*" \
        -not -path "./.git/*" \
        -not -path "./third_party/*")
    if [ -n "$SHELL_SCRIPTS" ]; then
        # shellcheck disable=SC2086
        if shellcheck $SHELL_SCRIPTS; then
            echo -e "${GREEN}✓ All shell scripts pass shellcheck${NC}"
        else
            echo -e "${RED}✗ Shellcheck failed${NC}"
            exit 1
        fi
    else
        echo -e "${YELLOW}⚠ No shell scripts found to check${NC}"
    fi
else
    echo -e "${YELLOW}⚠ shellcheck not installed, skipping${NC}"
    echo "  Install: sudo pacman -S shellcheck (Arch) or apt install shellcheck (Ubuntu)"
fi
echo ""

# Test 2: LEAN Format Check
echo "==> Test 2: LEAN Code Formatting"
export PATH="$HOME/.elan/bin:$PATH"
# LEAN doesn't have a standard formatter yet, but we enforce style via linter
# Check that build succeeds with -DwarningAsError=true (configured in lakefile.lean)
if lake build > /dev/null 2>&1; then
    echo -e "${GREEN}✓ All LEAN code passes linter checks${NC}"
else
    echo -e "${RED}✗ LEAN linter check failed${NC}"
    echo "  Fix warnings in LEAN files (configured with -DwarningAsError=true)"
    exit 1
fi
echo ""

# Test 3: Scala Format Check
echo "==> Test 3: Scala Code Formatting (scalafmt)"
cd chisel
if sbt scalafmtCheck > /dev/null 2>&1; then
    echo -e "${GREEN}✓ All Scala code is properly formatted${NC}"
else
    echo -e "${RED}✗ Scala formatting check failed${NC}"
    echo "  Run: cd chisel && sbt scalafmt"
    exit 1
fi
cd ..
echo ""

# Test 4: Main Smoke Test
echo "==> Test 4: Smoke Test (build, proofs, codegen, LEC)"
./verification/smoke-test.sh

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo -e "${GREEN}✓ ALL TESTS PASSED${NC}"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
