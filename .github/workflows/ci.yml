name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lean-build:
    name: Build LEAN Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install elan (LEAN toolchain manager)
        run: |
          curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y
          echo "$HOME/.elan/bin" >> $GITHUB_PATH

      - name: Show LEAN version
        run: |
          source $HOME/.elan/env
          lean --version
          lake --version

      - name: Cache LEAN dependencies
        uses: actions/cache@v4
        with:
          path: |
            .lake
            lake-packages
          key: ${{ runner.os }}-lean-${{ hashFiles('lean-toolchain', 'lakefile.lean', 'lake-manifest.json') }}
          restore-keys: |
            ${{ runner.os }}-lean-

      - name: Build LEAN project
        run: |
          source $HOME/.elan/env
          lake update
          lake build

      - name: Check for sorry (incomplete proofs)
        run: |
          source $HOME/.elan/env
          echo "Checking for 'sorry' in LEAN files..."
          if grep -r "sorry" lean/ --include="*.lean"; then
            echo "⚠️  Warning: Found incomplete proofs (sorry) in codebase"
            echo "This is expected during initial development"
          else
            echo "✓ No incomplete proofs found"
          fi

  scala-build:
    name: Build Scala/Chisel Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Setup Coursier (Scala toolchain manager)
        run: |
          curl -fL "https://github.com/coursier/launchers/raw/master/cs-x86_64-pc-linux.gz" | gzip -d > cs
          chmod +x cs
          ./cs setup --yes --jvm 11
          echo "$HOME/.local/share/coursier/bin" >> $GITHUB_PATH

      - name: Cache Coursier and sbt dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/coursier
            ~/.sbt
            ~/.ivy2/cache
            chisel/target
            chisel/project/target
          key: ${{ runner.os }}-sbt-${{ hashFiles('chisel/build.sbt', 'chisel/project/**') }}
          restore-keys: |
            ${{ runner.os }}-sbt-

      - name: Show Scala/sbt versions
        run: |
          java -version
          scala -version
          sbt --version

      - name: Compile Chisel code
        working-directory: ./chisel
        run: sbt compile

      - name: Check Scala formatting with scalafmt
        working-directory: ./chisel
        run: |
          echo "Checking Scala code formatting..."
          sbt scalafmtCheckAll
          echo "✓ All Scala files are properly formatted"

  format-check:
    name: Format and Lint Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Check shell scripts
        run: |
          # Make sure shell scripts are executable
          if [ -f verification/run-lec.sh ]; then
            test -x verification/run-lec.sh || echo "⚠️  verification/run-lec.sh is not executable"
          fi

          # Basic shell syntax check (exclude generated EQY/SBY working directories)
          if command -v shellcheck > /dev/null; then
            # Exclude verification/*/* (generated EQY/SBY files), but include verification/*.sh
            find . -name "*.sh" -type f -not -path "./verification/*/*" -exec shellcheck {} +
            echo "✓ All shell scripts pass shellcheck"
          else
            echo "shellcheck not available, skipping shell script checks"
          fi

      - name: Check Python scripts
        run: |
          python3 -m py_compile bootstrap.py
          echo "✓ Python syntax check passed"

      - name: Check trailing whitespace
        run: |
          echo "Checking for trailing whitespace..."
          if git grep -I --line-number '\s$' -- '*.lean' '*.scala' '*.md' '*.sh' '*.py'; then
            echo "⚠️  Found trailing whitespace (non-blocking)"
          else
            echo "✓ No trailing whitespace found"
          fi

      - name: Check for TODO markers
        run: |
          echo "Scanning for TODO/FIXME markers..."
          git grep -n -E 'TODO|FIXME|XXX|HACK' -- '*.lean' '*.scala' || echo "No TODO markers found"

  integration:
    name: Integration Test (Full Pipeline)
    runs-on: ubuntu-latest
    needs: [lean-build, scala-build]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install elan (LEAN)
        run: |
          curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y
          echo "$HOME/.elan/bin" >> $GITHUB_PATH

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Setup Coursier and sbt
        run: |
          curl -fL "https://github.com/coursier/launchers/raw/master/cs-x86_64-pc-linux.gz" | gzip -d > cs
          chmod +x cs
          ./cs setup --yes --jvm 11
          echo "$HOME/.local/share/coursier/bin" >> $GITHUB_PATH

      - name: Cache LEAN dependencies
        uses: actions/cache@v4
        with:
          path: |
            .lake
            lake-packages
          key: ${{ runner.os }}-lean-${{ hashFiles('lean-toolchain', 'lakefile.lean', 'lake-manifest.json') }}

      - name: Build LEAN
        run: |
          source $HOME/.elan/env
          make lean

      - name: Install Yosys for LEC
        run: |
          sudo apt-get update
          sudo apt-get install -y yosys

      - name: Run full pipeline (codegen → chisel → lec)
        run: |
          source $HOME/.elan/env
          echo "Running full pipeline: LEAN → Codegen → Chisel → LEC"
          make codegen
          make chisel
          make lec

      - name: Verify generated files
        run: |
          test -f output/sv-from-lean/FullAdder.sv || exit 1
          test -f output/sv-from-chisel/FullAdder.sv || exit 1
          test -f chisel/src/main/scala/generated/FullAdder.scala || exit 1
          echo "✓ All generated files present"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-outputs
          path: |
            output/**/*.sv
            output/**/*.v
            chisel/target/**/*.sv
          retention-days: 7

  docs-check:
    name: Documentation Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Check documentation files exist
        run: |
          test -f README.md || exit 1
          test -f CLAUDE.md || exit 1
          test -f GETTING_STARTED.md || exit 1
          test -f COMMANDS.md || exit 1
          test -f LICENSE || exit 1
          echo "✓ All required documentation files present"

      - name: Check markdown links
        run: |
          echo "Markdown link checking would go here"
          echo "Consider adding markdown-link-check in future"

      - name: Check for broken references
        run: |
          echo "Checking for broken file references in docs..."
          # Basic check for common paths mentioned in docs
          grep -r "lean/Shoumei" README.md CLAUDE.md GETTING_STARTED.md > /dev/null || echo "No lean references found"
          echo "✓ Documentation reference check complete"
