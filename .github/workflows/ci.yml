name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Shellcheck
        run: |
          SHELL_SCRIPTS=$(find . -name "*.sh" -type f \
            -not -path "./verification/FullAdder/*" \
            -not -path "./.git/*" \
            -not -path "./third_party/*")
          if [ -n "$SHELL_SCRIPTS" ]; then
            # shellcheck disable=SC2086
            shellcheck $SHELL_SCRIPTS
          fi

      - name: Python syntax
        run: python3 -m py_compile bootstrap.py

      - name: Trailing whitespace
        run: |
          if git grep -I --line-number '\s$' -- '*.lean' '*.scala' '*.md' '*.sh' '*.py'; then
            echo "Warning: trailing whitespace found (non-blocking)"
          fi

      - name: TODO scan
        run: git grep -n -E 'TODO|FIXME|XXX|HACK' -- '*.lean' '*.scala' || true

      - name: Documentation exists
        run: |
          test -f README.md
          test -f CLAUDE.md
          test -f GETTING_STARTED.md
          test -f COMMANDS.md
          test -f LICENSE

  proof-coverage:
    name: Proof Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run proof coverage analysis
        run: |
          chmod +x verification/proof-coverage.sh
          verification/proof-coverage.sh

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: proof-coverage-report
          path: |
            output/proof-coverage/proof-coverage.md
            output/proof-coverage/proof-coverage.json
          retention-days: 90

  lean-build:
    name: Lean Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install elan
        run: |
          curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y --default-toolchain none
          echo "$HOME/.elan/bin" >> $GITHUB_PATH

      - name: Cache .lake
        uses: actions/cache@v4
        with:
          path: |
            .lake
            lake-packages
          key: ${{ runner.os }}-lean-${{ hashFiles('lean-toolchain', 'lakefile.lean', 'lake-manifest.json') }}
          restore-keys: |
            ${{ runner.os }}-lean-

      - name: Build
        run: lake build

      - name: Check for sorry
        run: |
          if grep -r "sorry" lean/ --include="*.lean"; then
            echo "Warning: found incomplete proofs (sorry)"
          else
            echo "No incomplete proofs found"
          fi


  scala-build:
    name: Scala Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Setup Coursier
        run: |
          curl -fL "https://github.com/coursier/launchers/raw/master/cs-x86_64-pc-linux.gz" | gzip -d > cs
          chmod +x cs
          ./cs setup --yes --jvm 11
          echo "$HOME/.local/share/coursier/bin" >> $GITHUB_PATH

      - name: Cache sbt
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/coursier
            ~/.sbt
            ~/.ivy2/cache
            chisel/target
            chisel/project/target
          key: ${{ runner.os }}-sbt-${{ hashFiles('chisel/build.sbt', 'chisel/project/**') }}
          restore-keys: |
            ${{ runner.os }}-sbt-

      - name: Compile
        working-directory: ./chisel
        run: sbt compile

      - name: Check formatting
        working-directory: ./chisel
        run: sbt scalafmtCheckAll

  codegen:
    name: Code Generation
    runs-on: ubuntu-latest
    needs: [lean-build, scala-build]
    steps:
      - uses: actions/checkout@v4

      - name: Fetch riscv-opcodes submodule
        run: git submodule update --init third_party/riscv-opcodes

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install elan
        run: |
          curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y --default-toolchain none
          echo "$HOME/.elan/bin" >> $GITHUB_PATH

      - name: Cache .lake
        uses: actions/cache@v4
        with:
          path: |
            .lake
            lake-packages
          key: ${{ runner.os }}-lean-${{ hashFiles('lean-toolchain', 'lakefile.lean', 'lake-manifest.json') }}
          restore-keys: |
            ${{ runner.os }}-lean-

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Setup Coursier
        run: |
          curl -fL "https://github.com/coursier/launchers/raw/master/cs-x86_64-pc-linux.gz" | gzip -d > cs
          chmod +x cs
          ./cs setup --yes --jvm 11
          echo "$HOME/.local/share/coursier/bin" >> $GITHUB_PATH

      - name: Cache sbt
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/coursier
            ~/.sbt
            ~/.ivy2/cache
            chisel/target
            chisel/project/target
          key: ${{ runner.os }}-sbt-${{ hashFiles('chisel/build.sbt', 'chisel/project/**') }}
          restore-keys: |
            ${{ runner.os }}-sbt-

      - name: Generate code
        run: make codegen

      - name: Compile Chisel
        run: make chisel

      - name: Upload codegen artifact
        uses: actions/upload-artifact@v4
        with:
          name: codegen-output
          path: |
            output/sv-from-lean/
            output/sv-from-chisel/
            output/systemc/
            chisel/src/main/scala/generated/
            verification/compositional-certs.txt
          retention-days: 5

  lec:
    name: LEC Verification
    runs-on: ubuntu-latest
    needs: [codegen]
    steps:
      - uses: actions/checkout@v4

      - name: Download codegen artifact
        uses: actions/download-artifact@v4
        with:
          name: codegen-output

      - name: Install Yosys
        run: |
          sudo apt-get update
          sudo apt-get install -y yosys

      - name: Run LEC
        run: ./verification/run-lec.sh output/sv-from-lean output/sv-from-chisel

  systemc:
    name: SystemC Compilation
    runs-on: ubuntu-latest
    needs: [codegen]
    steps:
      - uses: actions/checkout@v4

      - name: Download codegen artifact
        uses: actions/download-artifact@v4
        with:
          name: codegen-output

      - name: Install SystemC
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake libsystemc-dev || {
            echo "libsystemc-dev not in repos, building from source..."
            curl -fsSL https://github.com/accellera-official/systemc/archive/refs/tags/2.3.4.tar.gz -o systemc.tar.gz
            tar xzf systemc.tar.gz
            cd systemc-2.3.4
            mkdir objdir && cd objdir
            ../configure --prefix=/usr/local
            make -j"$(nproc)"
            sudo make install
            sudo ldconfig
          }

      - name: Compile SystemC
        run: make systemc

  verilator-sim:
    name: Verilator Simulation
    runs-on: ubuntu-latest
    needs: [codegen]
    steps:
      - uses: actions/checkout@v4

      - name: Download codegen artifact
        uses: actions/download-artifact@v4
        with:
          name: codegen-output

      - name: Install Verilator
        run: |
          sudo apt-get update
          sudo apt-get install -y verilator

      - name: Build simulation
        run: make -C testbench sim

      - name: Check Verilator version
        run: verilator --version

      - name: Run simulation (pass test)
        run: ./build-sim/sim_shoumei +hex=testbench/tests/pass_test.hex +timeout=1000

      - name: Run simulation (dependency test)
        run: ./build-sim/sim_shoumei +hex=testbench/tests/dep_test.hex +timeout=2000

  smoke-test:
    name: Smoke Test
    runs-on: ubuntu-latest
    needs: [codegen]
    steps:
      - uses: actions/checkout@v4

      - name: Download codegen artifact
        uses: actions/download-artifact@v4
        with:
          name: codegen-output

      - name: Install Yosys
        run: |
          sudo apt-get update
          sudo apt-get install -y yosys

      - name: Run smoke tests
        run: |
          chmod +x verification/smoke-test.sh
          ./verification/smoke-test.sh
