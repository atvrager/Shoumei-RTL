#!/usr/bin/env bash
# Launch Claude Code inside the Shoumei-RTL devcontainer.
#
# Usage:
#   ./scripts/claude-dev            # interactive session
#   ./scripts/claude-dev --resume   # resume last session
#   ./scripts/claude-dev -p "..."   # one-shot prompt
#   ./scripts/claude-dev --workspace /path/to/worktree  # use a worktree
#
# Requires: devcontainer CLI (@devcontainers/cli)
#
# Forwards from host: API keys, git config, SSH keys, Claude settings,
# and relevant environment variables.
#
# Worktree support: by default, uses the git toplevel of the current
# directory (works for both the main repo and worktrees). Override with
# --workspace <path>.

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

# â”€â”€ Determine workspace (repo root or worktree) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
REPO_ROOT=""
CLAUDE_ARGS=()
while [[ $# -gt 0 ]]; do
  case "$1" in
    --workspace)
      REPO_ROOT="$(cd "$2" && pwd)"
      shift 2
      ;;
    *)
      CLAUDE_ARGS+=("$1")
      shift
      ;;
  esac
done
set -- "${CLAUDE_ARGS[@]+"${CLAUDE_ARGS[@]}"}"

if [[ -z "$REPO_ROOT" ]]; then
  # Prefer git toplevel of cwd (works in worktrees), fall back to script location
  REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || git -C "$SCRIPT_DIR" rev-parse --show-toplevel 2>/dev/null || (cd "$SCRIPT_DIR/.." && pwd))"
fi

# â”€â”€ Worktree detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
MAIN_WORKTREE="$(git -C "$REPO_ROOT" rev-parse --path-format=absolute --git-common-dir 2>/dev/null | sed 's|/\.git$||')"
if [[ -n "$MAIN_WORKTREE" && "$MAIN_WORKTREE" != "$REPO_ROOT" ]]; then
  BRANCH="$(git -C "$REPO_ROOT" rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")"
  echo "ðŸŒ³ Worktree detected: $REPO_ROOT (branch: $BRANCH)"
  echo "   Main repo: $MAIN_WORKTREE"
fi

# â”€â”€ Ensure submodules are initialized (worktrees don't inherit them) â”€
git -C "$REPO_ROOT" submodule update --init --quiet 2>/dev/null || true

# â”€â”€ Workspace mount strategy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Mount at the host's absolute path so git's internal absolute paths
# (worktree gitdirs, submodule core.worktree) all resolve correctly.
# This avoids the /workspaces/<name> vs /home/user/src/<name> mismatch.
EXTRA_UP_ARGS=()

# Always mount workspace at its host path for consistency
EXTRA_UP_ARGS+=(--workspace-mount "type=bind,source=$REPO_ROOT,target=$REPO_ROOT")

if [[ -n "$MAIN_WORKTREE" && "$MAIN_WORKTREE" != "$REPO_ROOT" ]]; then
  # Worktree: also mount main repo's .git for object store access
  EXTRA_UP_ARGS+=(--mount "type=bind,source=$MAIN_WORKTREE/.git,target=$MAIN_WORKTREE/.git")
fi

# Disable auto git-root mount (conflicts with our explicit mount)
EXTRA_UP_ARGS+=(--mount-workspace-git-root=false)

# â”€â”€ Ensure the container is running â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ! devcontainer up --workspace-folder "$REPO_ROOT" "${EXTRA_UP_ARGS[@]}" 2>&1 | tee /dev/stderr | grep -q '"outcome":"success"'; then
  echo "Error: devcontainer failed to start. See output above." >&2
  exit 1
fi

# â”€â”€ Build env var forwarding list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ENV_ARGS=()
forward_var() {
  local var="$1"
  if [[ -n "${!var:-}" ]]; then
    ENV_ARGS+=("$var=${!var}")
  fi
}

# Auth
forward_var ANTHROPIC_API_KEY
forward_var GITHUB_PERSONAL_ACCESS_TOKEN

# Claude settings
forward_var CLAUDE_CODE_MAX_OUTPUT_TOKENS
forward_var CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS

# Terminal
forward_var TERM
forward_var COLORTERM
forward_var LANG

# â”€â”€ Launch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
exec devcontainer exec \
  --workspace-folder "$REPO_ROOT" \
  env "${ENV_ARGS[@]}" \
  claude --dangerously-skip-permissions "$@"
